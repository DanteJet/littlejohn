{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container my-4">
  <div class="row g-4 align-items-start">

    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª—è -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header d-flex align-items-center justify-content-between" style="background:#d8f3dc;">
          <h5 class="m-0">–°–æ–∑–¥–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è</h5>
        </div>
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">–õ–æ–≥–∏–Ω</label>
              <input name="username" class="form-control" required placeholder="login">
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input name="email" type="email" class="form-control" placeholder="parent@example.com">
            </div>
            <div class="mb-3">
              <label class="form-label">–í—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å</label>
              <div class="input-group">
                <input name="password" type="text" class="form-control" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: Temp123!">
                <button type="button" class="btn btn-outline-secondary" id="genPassBtn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
            </div>
            <div class="text-end">
              <button class="btn btn-success px-4">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Å–ø–∏—Å–æ–∫ —Ä–æ–¥–∏—Ç–µ–ª–µ–π -->
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header" style="background:#d8f3dc;">
          <h5 class="m-0">–†–æ–¥–∏—Ç–µ–ª–∏</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
              <thead>
                <tr>
                  <th style="width:40px;"></th>
                  <th>–õ–æ–≥–∏–Ω</th>
                  <th>Email</th>
                  <th class="text-center">–î–µ—Ç–µ–π</th>
                  <th style="width:1%; white-space:nowrap;">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody>
                {% for p in parents %}
                  <!-- —Å—Ç—Ä–æ–∫–∞-—Ä–æ–¥–∏—Ç–µ–ª—å -->
                  <tr class="cursor-pointer" data-bs-toggle="collapse" data-bs-target="#children-{{ p.id }}" aria-expanded="false">
                    <td class="text-muted">‚ñ∏</td>
                    <td>{{ p.username }}</td>
                    <td>{{ p.email|default:"‚Äî" }}</td>
                    <td class="text-center"><span class="badge text-bg-primary">{{ p.children_count }}</span></td>
                    <td class="text-nowrap">
                      <form method="post" action="{% url 'parent_delete' p.id %}" class="m-0 d-inline"
                            onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è ¬´{{ p.username }}¬ª –∏ –≤—Å–µ—Ö –µ–≥–æ –¥–µ—Ç–µ–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.');">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </td>
                  </tr>
                  <!-- —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∞—è—Å—è —Å—Ç—Ä–æ–∫–∞ —Å –¥–µ—Ç—å–º–∏ -->
                  <tr class="collapse bg-light" id="children-{{ p.id }}">
                    <td></td>
                    <td colspan="3">
                      {% if p.children.all %}
                        <ul class="list-unstyled mb-0">
                          {% for c in p.children.all %}
                            <li class="py-1">
                              <a href="{% url 'child_detail' c.id %}" class="link-dark text-decoration-none">
                                <li class="py-1">
                                    <a href="{% url 'child_detail' c.id %}" class="link-dark text-decoration-none">
                                      {% if c.gender == 'M' %}üë¶{% elif c.gender == 'F' %}üëß{% else %}üßí{% endif %}
                                      {{ c.first_name }} {{ c.last_name }}
                                    </a>
                          {% empty %}
                            <li class="text-muted">–î–µ—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <span class="text-muted">–î–µ—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</span>
                      {% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª–µ–π</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- –Ω–µ–±–æ–ª—å—à–æ–π JS: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è –∏ —Å—Ç—Ä–µ–ª–æ—á–∫–∞ ‚ñ∏/‚ñæ -->
<script>
document.getElementById('genPassBtn')?.addEventListener('click', function(){
  const input = this.closest('.input-group').querySelector('input[name="password"]');
  function rnd(n){ return Math.random().toString(36).slice(2,2+n); }
  input.value = 'M' + rnd(3) + (Math.floor(10+Math.random()*89)) + '!' + rnd(2).toUpperCase();
});
document.addEventListener('show.bs.collapse', e => {
  const row = e.target.previousElementSibling;
  if (row && row.querySelector('td')) row.querySelector('td').textContent = '‚ñæ';
});
document.addEventListener('hide.bs.collapse', e => {
  const row = e.target.previousElementSibling;
  if (row && row.querySelector('td')) row.querySelector('td').textContent = '‚ñ∏';
});
</script>
{% endblock %}
