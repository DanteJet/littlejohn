{% extends 'base.html' %}
{% load static %}
{% load get_item %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">
      Расписание — неделя
      {% if week_start and week_end %}
        {{ week_start|date:"d.m.Y" }}–{{ week_end|date:"d.m.Y" }}
      {% endif %}
    </h4>

    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-primary" data-bs-toggle="collapse" href="#sessionForm" role="button" aria-expanded="false" aria-controls="sessionForm">
        Добавить занятие
      </a>
      <a class="btn btn-sm btn-outline-secondary"
         href="{% url 'sessions_week' %}{% if prev_start %}?start={{ prev_start|date:'Y-m-d' }}{% endif %}">
        ← Предыдущая
      </a>
      <a class="btn btn-sm btn-outline-secondary"
         href="{% url 'sessions_week' %}{% if next_start %}?start={{ next_start|date:'Y-m-d' }}{% endif %}">
        Следующая →
      </a>
    </div>
  </div>

  <div class="collapse mb-3" id="sessionForm">
    <div class="card shadow-sm border-0">
      <div class="card-header" style="background:#d8f3dc;">
        <h5 class="m-0">Новое занятие</h5>
      </div>
      <div class="card-body">
        <form method="post" action="{% url 'session_create' %}" class="grid-form">
          {% csrf_token %}

          <div class="row g-3 align-items-center mb-3">
            <div class="col-12 col-sm-4">
              <label class="form-label mb-0" for="{{ form.date.id_for_label }}">{{ form.date.label }}</label>
            </div>
            <div class="col-12 col-sm-8">{{ form.date }}</div>
          </div>

          <div class="row g-3 align-items-center mb-3">
            <div class="col-12 col-sm-4">
              <label class="form-label mb-0" for="{{ form.time.id_for_label }}">{{ form.time.label }}</label>
            </div>
            <div class="col-12 col-sm-8">{{ form.time }}</div>
          </div>

          <div class="row g-3 align-items-center mb-3">
            <div class="col-12 col-sm-4">
              <label class="form-label mb-0" for="{{ form.duration_minutes.id_for_label }}">{{ form.duration_minutes.label }}</label>
            </div>
            <div class="col-12 col-sm-8">
              <div class="stepper">
                <button type="button" class="stepper-btn" data-step="-15">−</button>
                {{ form.duration_minutes }}
                <button type="button" class="stepper-btn" data-step="15">+</button>
              </div>
            </div>
          </div>

          <div class="row g-3 align-items-start mb-3">
            <div class="col-12 col-sm-4">
              <label class="form-label mb-0" for="{{ form.participants.id_for_label }}">{{ form.participants.label }}</label>
            </div>
            <div class="col-12 col-sm-8">{{ form.participants }}</div>
          </div>

          <div class="row g-3 align-items-start mb-3">
            <div class="col-12 col-sm-4">
              <label class="form-label mb-0" for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
            </div>
            <div class="col-12 col-sm-8">{{ form.notes }}</div>
          </div>

          <div class="form-check mb-3">
            {{ form.fill_month }} {{ form.fill_month.label_tag }}
          </div>

          <div class="text-end">
            <button type="submit" class="btn btn-success px-4">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<table class="table table-bordered text-center align-middle">
    <thead class="table-light">
      <tr>
        <th>Время</th>
        {% for day in days %}
          <th class="{% if day == today %}table-success{% endif %}">{{ day|date:"D, d.m" }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in table_rows %}
        <tr>
          <th class="text-nowrap">{{ row.time|time:"H:i" }}</th>
          {% for cell in row.slots %}
            <td class="{% if cell.day == today %}table-success{% endif %}">
              {% with slot=cell.slot %}
                {% if slot %}
                  <div class="fw-semibold">{{ slot.start|date:"H:i" }}–{{ slot.end|date:"H:i" }}</div>
                
                <div class="small mt-1">
                    Участники:
                    {% if slot.participants %}
                      {% for p in slot.participants %}
                        <span class="badge text-bg-success me-1">{{ p.first_name }}</span>
                      {% endfor %}
                    {% else %}
                      <span class="text-muted">пока нет</span>
                    {% endif %}
                    {% if slot.session_ids|length > 1 %}
                      <span class="badge text-bg-warning ms-1">объединено {{ slot.session_ids|length }}</span>
                    {% endif %}
                  </div>

                <div class="mt-2 d-flex gap-1 justify-content-center">
                    <a href="{% url 'session_edit' slot.session_ids.0 %}" class="btn btn-sm btn-outline-primary">Ред.</a>
                    <form method="post" action="{% url 'session_delete' slot.session_ids.0 %}" onsubmit="return confirm('Удалить занятие?');">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-danger">Удалить</button>
                    </form>
                  </div>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              {% endwith %}
              
            </td>
          {% endfor %}
        </tr>
      {% empty %}
        <tr>
          <td colspan="{{ days|length|add:1 }}" class="text-muted">Нет занятий</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
