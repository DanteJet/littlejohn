{% extends 'base.html' %}
{% load static %}
{% load get_item %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">
      Расписание — неделя
      {% if week_start and week_end %}
        {{ week_start|date:"d.m.Y" }}–{{ week_end|date:"d.m.Y" }}
      {% endif %}
    </h4>

    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-primary" data-bs-toggle="collapse" href="#sessionForm" role="button" aria-expanded="false" aria-controls="sessionForm">
        Добавить занятие
      </a>
      <a class="btn btn-sm btn-outline-secondary"
         href="{% url 'sessions_week' %}{% if prev_start %}?start={{ prev_start|date:'Y-m-d' }}{% endif %}">
        ← Предыдущая
      </a>
      <a class="btn btn-sm btn-outline-secondary"
         href="{% url 'sessions_week' %}{% if next_start %}?start={{ next_start|date:'Y-m-d' }}{% endif %}">
        Следующая →
      </a>
    </div>
  </div>

  <div class="collapse mb-3" id="sessionForm">
    <div class="card card-body">
      <form method="post" action="{% url 'session_create' %}">
        {% csrf_token %}
        <div class="row g-2">
          <div class="col-md-3">{{ form.start.label_tag }}{{ form.start }}</div>
          <div class="col-md-2">{{ form.duration_minutes.label_tag }}{{ form.duration_minutes }}</div>
          <div class="col-md-4">{{ form.participants.label_tag }}{{ form.participants }}</div>
          <div class="col-md-3">{{ form.notes.label_tag }}{{ form.notes }}</div>
          <div class="col-md-3 form-check mt-2">{{ form.fill_month }} {{ form.fill_month.label_tag }}</div>
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-primary btn-sm">Сохранить</button>
        </div>
      </form>
    </div>
  </div>

  <div class="row row-cols-1 row-cols-md-7 g-3">
    {% for day in days %}
      <div class="col">
        <div class="fw-semibold mb-2">{{ day|date:"D, d.m" }}</div>

        {% with slots=slots_by_day|get_item:day %}
          {% if slots %}
            {% for slot in slots %}
              <div class="border rounded p-2 mb-2 calendar-slot">
                <div class="fw-semibold">{{ slot.start|date:"H:i" }}–{{ slot.end|date:"H:i" }}</div>

                <div class="small mt-1">
                  Участники:
                  {% if slot.participants %}
                    {% for p in slot.participants %}
                      <span class="badge text-bg-success me-1">{{ p.first_name }}</span>
                    {% endfor %}
                  {% else %}
                    <span class="text-muted">пока нет</span>
                  {% endif %}
                  {% if slot.session_ids|length > 1 %}
                    <span class="badge text-bg-warning ms-1">объединено {{ slot.session_ids|length }}</span>
                  {% endif %}
                </div>

                {# При необходимости действия делаем через slot.session_ids.0 #}
                {# <form method="post" ...> <input type="hidden" name="session_id" value="{{ slot.session_ids.0 }}"> ... </form> #}
              </div>
            {% endfor %}
          {% else %}
            <div class="text-muted small">Нет занятий</div>
          {% endif %}
        {% endwith %}
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
