{% extends 'base.html' %}
{% load static %}
{% load get_item %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">
      Расписание — неделя
      {% if week_start and week_end %}
        {{ week_start|date:"d.m.Y" }}–{{ week_end|date:"d.m.Y" }}
      {% endif %}
    </h4>

    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-primary" data-bs-toggle="collapse" href="#sessionForm" role="button" aria-expanded="false" aria-controls="sessionForm">
        Добавить занятие
      </a>
      <a class="btn btn-sm btn-outline-secondary"
         href="{% url 'sessions_week' %}{% if prev_start %}?start={{ prev_start|date:'Y-m-d' }}{% endif %}">
        ← Предыдущая
      </a>
      <a class="btn btn-sm btn-outline-secondary"
         href="{% url 'sessions_week' %}{% if next_start %}?start={{ next_start|date:'Y-m-d' }}{% endif %}">
        Следующая →
      </a>
    </div>
  </div>

  <div class="collapse mb-3" id="sessionForm">
    <div class="card shadow-sm border-0">
      <div class="card-header" style="background:#d8f3dc;">
        <h5 class="m-0">Новое занятие</h5>
      </div>
      <div class="card-body">
        <form method="post" action="{% url 'session_create' %}" class="grid-form">
          {% csrf_token %}

          <div class="row g-3 align-items-center mb-3">
            <div class="col-12 col-sm-4">
              <label class="form-label mb-0" for="{{ form.start.id_for_label }}">{{ form.start.label }}</label>
            </div>
            <div class="col-12 col-sm-8">{{ form.start }}</div>
          </div>

          <div class="row g-3 align-items-center mb-3">
            <div class="col-12 col-sm-4">
              <label class="form-label mb-0" for="{{ form.duration_minutes.id_for_label }}">{{ form.duration_minutes.label }}</label>
            </div>
            <div class="col-12 col-sm-8">
              <div class="stepper">
                <button type="button" class="stepper-btn" data-step="-15">−</button>
                {{ form.duration_minutes }}
                <button type="button" class="stepper-btn" data-step="15">+</button>
              </div>
            </div>
          </div>

          <div class="row g-3 align-items-start mb-3">
            <div class="col-12 col-sm-4">
              <label class="form-label mb-0" for="{{ form.participants.id_for_label }}">{{ form.participants.label }}</label>
            </div>
            <div class="col-12 col-sm-8">{{ form.participants }}</div>
          </div>

          <div class="row g-3 align-items-start mb-3">
            <div class="col-12 col-sm-4">
              <label class="form-label mb-0" for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
            </div>
            <div class="col-12 col-sm-8">{{ form.notes }}</div>
          </div>

          <div class="form-check mb-3">
            {{ form.fill_month }} {{ form.fill_month.label_tag }}
          </div>

          <div class="text-end">
            <button type="submit" class="btn btn-success px-4">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="row row-cols-1 row-cols-md-7 g-3">
    {% for day in days %}
      <div class="col">
        <div class="fw-semibold mb-2">{{ day|date:"D, d.m" }}</div>

        {% with slots=slots_by_day|get_item:day %}
          {% if slots %}
            {% for slot in slots %}
              <div class="border rounded p-2 mb-2 calendar-slot">
                <div class="fw-semibold">{{ slot.start|date:"H:i" }}–{{ slot.end|date:"H:i" }}</div>

                <div class="small mt-1">
                  Участники:
                  {% if slot.participants %}
                    {% for p in slot.participants %}
                      <span class="badge text-bg-success me-1">{{ p.first_name }}</span>
                    {% endfor %}
                  {% else %}
                    <span class="text-muted">пока нет</span>
                  {% endif %}
                  {% if slot.session_ids|length > 1 %}
                    <span class="badge text-bg-warning ms-1">объединено {{ slot.session_ids|length }}</span>
                  {% endif %}
                </div>

                {# При необходимости действия делаем через slot.session_ids.0 #}
                {# <form method="post" ...> <input type="hidden" name="session_id" value="{{ slot.session_ids.0 }}"> ... </form> #}
              </div>
            {% endfor %}
          {% else %}
            <div class="text-muted small">Нет занятий</div>
          {% endif %}
        {% endwith %}
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
